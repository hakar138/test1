<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wave Simulator — P2P Teacher / Student (PeerJS)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
  /* Minimal polished styles adapted from earlier version */
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
  body{min-height:100vh;background:linear-gradient(135deg,#081028,#2b2e83);color:#fff;padding:18px;display:flex;justify-content:center;align-items:flex-start}
  .wrap{width:100%;max-width:1100px}
  header{margin-bottom:12px}
  h1{font-size:1.6rem;margin-bottom:6px}
  .role-selection{display:flex;gap:12px;margin-bottom:12px}
  .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start}
  .panel{flex:1;min-width:280px}
  .canvas-panel{flex:1.4;min-width:320px}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type=number],input[type=text],input[type=password]{width:100%;padding:8px;border-radius:6px;border:none;background:#fff;color:#111}
  button{padding:8px 10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .teacher-btn{background:#ff7e00;color:#000}
  .copy-btn{background:#2196F3;color:#fff}
  .back-btn{background:#6c757d;color:#fff}
  .status{margin-top:8px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.03);font-weight:700}
  .connected{background:rgba(76,175,80,0.15);color:#bfffbf}
  .disconnected{background:rgba(175,76,76,0.12);color:#ffdede}
  .waveCanvas{width:100%;height:300px;background:rgba(0,0,0,0.45);border-radius:6px}
  .student-list{margin-top:8px;max-height:140px;overflow:auto;padding:6px;background:rgba(255,255,255,0.02);border-radius:6px}
  .student-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between}
  .small{width:48%}
  @media(max-width:900px){.role-selection{flex-direction:column}.card{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Wave Simulator — P2P (Teacher ↔ Student)</h1>
      <div style="opacity:0.85">Teacher broadcasts wave params; students join with code and get params in real-time.</div>
    </header>

    <div class="role-selection">
      <div class="card" style="flex-direction:column">
        <div style="font-weight:800;margin-bottom:8px">Choose a Role</div>
        <div style="display:flex;gap:8px">
          <button id="teacherRole" class="teacher-btn">Teacher (Host)</button>
          <button id="studentRole" class="copy-btn">Student (Join)</button>
        </div>
        <div style="margin-top:8px;font-size:0.9rem;opacity:0.85">Password for teacher: <strong>DHH</strong></div>
      </div>
    </div>

    <!-- Teacher Screen -->
    <div class="card panel" id="teacherScreen" style="display:none;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Teacher Panel</div>
        <div id="teacherStatus" class="status disconnected">Locked / Not broadcasting</div>
      </div>

      <div style="margin-top:10px">
        <label>Wavelength (m)</label>
        <input id="teacherWavelength" type="number" min="0.1" step="0.1" value="40">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="small">
          <label>Frequency (Hz)</label>
          <input id="teacherFrequency" type="number" min="0.01" step="0.01" value="1.5">
        </div>
        <div class="small">
          <label>Velocity (m/s) — computed</label>
          <input id="teacherVelocity" type="number" readonly value="60">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="setTeacherWave" class="teacher-btn">Set & Broadcast</button>
        <button id="regenCode" class="copy-btn">Generate Code</button>
        <button id="copyCode" class="back-btn">Copy Code</button>
      </div>

      <div style="margin-top:8px">
        <label>Connection Code</label>
        <div id="teacherCode" style="padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;font-weight:800;letter-spacing:3px">Not generated</div>
      </div>

      <div style="margin-top:12px;font-weight:700">Connected Students</div>
      <div class="student-list" id="teacherStudentList">
        <div class="student-item">No students connected yet</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="stopTeacher" class="back-btn">Stop / Exit</button>
      </div>
    </div>

    <!-- Student Screen -->
    <div class="card panel" id="studentScreen" style="display:none;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Student Panel</div>
        <div id="studentStatus" class="status disconnected">Not connected</div>
      </div>

      <div style="margin-top:8px">
        <label>Connection Code</label>
        <input id="connectionCode" type="text" placeholder="Enter teacher code">
      </div>
      <div style="margin-top:8px">
        <label>Your Name</label>
        <input id="studentName" type="text" placeholder="Your name (displayed to teacher)">
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="small">
          <label>Wavelength (m)</label>
          <input id="studentWavelength" type="number" min="0.1" step="0.1" value="20">
        </div>
        <div class="small">
          <label>Frequency (Hz)</label>
          <input id="studentFrequency" type="number" min="0.01" step="0.01" value="2">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Velocity (m/s) — computed</label>
        <input id="studentVelocity" readonly value="40">
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="connectBtn" class="copy-btn">Connect</button>
        <button id="checkMatch" class="teacher-btn">Check Match</button>
      </div>

      <div style="margin-top:8px;font-weight:700">Match Status</div>
      <div id="matchStatus" class="status disconnected">Waiting</div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="stopStudent" class="back-btn">Back / Exit</button>
      </div>
    </div>

    <!-- Canvas and visualization -->
    <div class="card canvas-panel" id="canvasCard" style="flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Wave Simulation</div>
        <div style="opacity:0.85">Teacher & Student each have their own canvas</div>
      </div>
      <canvas id="waveCanvas" class="waveCanvas"></canvas>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:6px">Wavelength: <span id="displayWavelength">40</span> m</div>
        <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:6px">Frequency: <span id="displayFrequency">1.5</span> Hz</div>
        <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:6px">Velocity: <span id="displayVelocity">60</span> m/s</div>
      </div>
    </div>

  </div>

<script>
/* ----------------------------
   P2P-enabled Wave Simulator
   ---------------------------- */
const password = 'DHH';

/* DOM refs */
const teacherRole = document.getElementById('teacherRole');
const studentRole = document.getElementById('studentRole');
const teacherScreen = document.getElementById('teacherScreen');
const studentScreen = document.getElementById('studentScreen');
const setTeacherWave = document.getElementById('setTeacherWave');
const regenCode = document.getElementById('regenCode');
const copyCode = document.getElementById('copyCode');
const teacherCodeEl = document.getElementById('teacherCode');
const teacherStatus = document.getElementById('teacherStatus');
const teacherWavelength = document.getElementById('teacherWavelength');
const teacherFrequency = document.getElementById('teacherFrequency');
const teacherVelocity = document.getElementById('teacherVelocity');
const teacherStudentList = document.getElementById('teacherStudentList');
const stopTeacher = document.getElementById('stopTeacher');

const connectionCode = document.getElementById('connectionCode');
const studentName = document.getElementById('studentName');
const studentWavelength = document.getElementById('studentWavelength');
const studentFrequency = document.getElementById('studentFrequency');
const studentVelocity = document.getElementById('studentVelocity');
const connectBtn = document.getElementById('connectBtn');
const checkMatchBtn = document.getElementById('checkMatch');
const matchStatus = document.getElementById('matchStatus');
const studentStatus = document.getElementById('studentStatus');
const stopStudent = document.getElementById('stopStudent');

const displayWavelength = document.getElementById('displayWavelength');
const displayFrequency = document.getElementById('displayFrequency');
const displayVelocity = document.getElementById('displayVelocity');
const canvas = document.getElementById('waveCanvas');

/* state */
let isTeacher = false;
let peer = null;
let connections = []; // teacher: multiple connections; student: single connection at index 0
let teacherCodeValue = null;
let teacherParams = { wavelength: 40, frequency: 1.5, velocity: 60 };
let studentParams = { wavelength: 20, frequency: 2, velocity: 40 };
let anim = { last:0, t:0 };
let raf = null;

/* PeerJS script is loaded; create wrappers */

/* Utility: generate code */
function generateCode(len=6){
  return Math.random().toString(36).substring(2,2+len).toUpperCase();
}

/* UI helpers */
function updateTeacherUI(){
  displayWavelength.textContent = teacherParams.wavelength;
  displayFrequency.textContent = teacherParams.frequency;
  displayVelocity.textContent = teacherParams.velocity;
  teacherWavelength.value = teacherParams.wavelength;
  teacherFrequency.value = teacherParams.frequency;
  teacherVelocity.value = teacherParams.velocity;
}

function updateStudentUI(){
  studentWavelength.value = studentParams.wavelength;
  studentFrequency.value = studentParams.frequency;
  studentVelocity.value = studentParams.velocity;
  displayWavelength.textContent = studentParams.wavelength;
  displayFrequency.textContent = studentParams.frequency;
  displayVelocity.textContent = studentParams.velocity;
}

function setStatus(el, text, connected){
  el.textContent = text;
  el.className = connected ? 'status connected' : 'status disconnected';
}

/* Canvas HiDPI helper */
function makeHiDPICanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(1, Math.floor(rect.width * dpr));
  canvas.height = Math.max(1, Math.floor(rect.height * dpr));
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

/* Wave drawing (same physics mapping used earlier) */
function lambdaToPixels(lambda, canvasWidth){
  const base = Math.max(20, lambda * 6);
  return Math.min(base, canvasWidth * 0.6);
}
function drawGrid(ctx, canvas){
  const w = canvas.width/(window.devicePixelRatio||1);
  const h = canvas.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  for(let y=0;y<=h;y+=24){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  for(let x=0;x<=w;x+=24){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  ctx.strokeStyle = 'rgba(255,255,255,0.18)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
  ctx.restore();
}
function drawWave(ctx, canvas, params, time, color='#4CAF50'){
  const w = canvas.width/(window.devicePixelRatio||1), h = canvas.height/(window.devicePixelRatio||1);
  const amp = h*0.18;
  const lambda_px = lambdaToPixels(params.wavelength, w);
  const k = 2*Math.PI / lambda_px;
  const omega = 2*Math.PI * params.frequency;
  ctx.save();
  ctx.lineWidth = 3; ctx.strokeStyle = color;
  ctx.beginPath();
  for(let x=0;x<=w;x++){
    const y = h/2 + amp * Math.sin(k*x - omega*time);
    if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.fillStyle = '#FF9800';
  for(let x=0;x<=w;x+=Math.max(16, Math.floor(lambda_px/8))){
    const y = h/2 + amp * Math.sin(k*x - omega*time);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  }
  // labels
  const cx=w/2; const wx1=cx-lambda_px/2; const wx2=cx+lambda_px/2;
  ctx.strokeStyle='#FF4081'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(wx1,h*0.12); ctx.lineTo(wx2,h*0.12); ctx.stroke();
  ctx.font='14px Arial'; ctx.fillStyle='white'; ctx.textAlign='center';
  ctx.fillText(`λ ≈ ${params.wavelength} m`, cx, h*0.12-12);
  ctx.restore();
}

function animate(timestamp){
  if(!anim.last) anim.last = timestamp;
  const dt = (timestamp - anim.last)/1000; anim.last = timestamp; anim.t += dt;
  const ctx = makeHiDPICanvas(canvas);
  drawGrid(ctx, canvas);
  if(isTeacher) drawWave(ctx, canvas, teacherParams, anim.t, '#ffb86b'); else drawWave(ctx, canvas, studentParams, anim.t, '#64b5ff');
  raf = requestAnimationFrame(animate);
}

/* PeerJS integration */
/* Teacher: create Peer with id=teacherCodeValue, accept connections; broadcast params on set.
   Student: create a random Peer, connect to teacher code; on open send join {type:'join', name} and on receiving 'params' update UI. */

function teacherStartSession(code){
  try {
    peer = new Peer(code);
  } catch(e){
    console.error('Peer create error', e); setStatus(teacherStatus,'Peer init failed', false); return;
  }
  teacherCodeValue = code;
  teacherCodeEl.textContent = code;
  setStatus(teacherStatus, 'Hosting — waiting for students', true);
  connections = [];
  peer.on('open', id => {
    console.log('Teacher Peer open', id);
  });
  peer.on('connection', conn => {
    // store connection
    connections.push(conn);
    conn.on('open', () => {
      // expect join message with name
      conn.on('data', data => {
        try{
          if(data && data.type === 'join'){
            const name = data.name || 'Student';
            // add to UI
            addStudentToList(name, conn);
            // send current params
            conn.send({ type:'params', params: teacherParams });
          } else if(data && data.type === 'matchAttempt'){
            // teacher receives student's attempt result or values
            const payload = data; // contains student's current params and name
            // append to teacher UI or console
            addStudentToList(payload.name, conn, payload); // update list and show last attempt
          }
        }catch(e){ console.error(e); }
      });
    });
    conn.on('close', () => { removeConnection(conn); });
    conn.on('error', err=>{ console.warn('conn err', err); removeConnection(conn); });
  });
  peer.on('error', err => { console.error('peer error', err); setStatus(teacherStatus,'Peer error', false); });
}

function studentStartSession(code, name){
  try {
    peer = new Peer();
  } catch(e){ console.error('Peer error', e); setStatus(studentStatus,'Peer init failed', false); return; }
  // attempt connection
  const conn = peer.connect(code);
  conn.on('open', () => {
    setStatus(studentStatus, 'Connected', true);
    // send join message with name
    conn.send({ type:'join', name: name || 'Student' });
  });
  conn.on('data', data => {
    // expect {type:'params', params: {...}}
    if(data && data.type === 'params'){
      teacherParams = data.params;
      // update teacher UI (display & canvas will switch to teacher view when teacher connected? We're in student mode)
      // auto-fill student's fields so they can try to match
      studentParams = { ...teacherParams }; // or optionally pre-fill to teacher values so they can see
      updateStudentUI();
      setStatus(studentStatus, 'Connected (received params)', true);
      if(matchStatus) { matchStatus.className='status connected'; matchStatus.textContent='Parameters received from teacher (auto-filled)'; }
    }
  });
  conn.on('close', () => { setStatus(studentStatus, 'Disconnected', false); });
  conn.on('error', err => { console.error('conn err', err); setStatus(studentStatus, 'Connection error', false); });
  connections = [conn];
}

/* Manage teacher student-list UI */
function addStudentToList(name, conn, lastAttemptPayload){
  // check existing
  const items = Array.from(teacherStudentList.querySelectorAll('.student-item'));
  const found = items.find(it => it.dataset.name === name);
  if(found) {
    // update timestamp or payload
    found.querySelector('.right') && (found.querySelector('.right').textContent = lastAttemptPayload ? 'Attempted' : 'Connected');
    return;
  }
  teacherStudentList.innerHTML = ''; // clear "no students"
  const el = document.createElement('div');
  el.className = 'student-item';
  el.dataset.name = name;
  el.innerHTML = `<div>${name}</div><div class="right">${lastAttemptPayload ? 'Attempted' : 'Connected'}</div>`;
  teacherStudentList.appendChild(el);
}

function removeConnection(conn){
  connections = connections.filter(c => c !== conn);
  // re-render teacher student list
  if(connections.length === 0){
    teacherStudentList.innerHTML = '<div class="student-item">No students connected yet</div>';
  } else {
    // naive rebuild
    teacherStudentList.innerHTML = '';
    for(const c of connections){
      // we don't have the name easily; list placeholder
      const el = document.createElement('div');
      el.className = 'student-item';
      el.innerHTML = `<div>Peer</div><div class="right">Connected</div>`;
      teacherStudentList.appendChild(el);
    }
  }
}

/* UI Actions wiring */
teacherRole.addEventListener('click', ()=> {
  const pwd = prompt('Enter teacher password:');
  if(pwd !== password){ alert('Incorrect password'); return; }
  isTeacher = true;
  studentScreen.style.display='none';
  teacherScreen.style.display='flex';
  // generate code if none
  if(!teacherCodeValue) teacherCodeValue = generateCode(6);
  teacherCodeEl.textContent = teacherCodeValue;
  // create peer with id = code
  teacherStartSession(teacherCodeValue);
  // start animation
  cancelAnimationFrame(raf); anim={last:0,t:0}; raf = requestAnimationFrame(animate);
});

studentRole.addEventListener('click', ()=> {
  isTeacher = false;
  teacherScreen.style.display='none';
  studentScreen.style.display='flex';
  cancelAnimationFrame(raf); anim={last:0,t:0}; raf = requestAnimationFrame(animate);
});

/* regenerate/copy */
regenCode.addEventListener('click', ()=> {
  teacherCodeValue = generateCode(6);
  teacherCodeEl.textContent = teacherCodeValue;
  // if already hosting, re-create Peer with new id (destroy old)
  if(peer){
    try{ peer.destroy(); }catch(e){}
    teacherStartSession(teacherCodeValue);
  }
});
copyCode.addEventListener('click', ()=> {
  if(teacherCodeValue){
    navigator.clipboard?.writeText(teacherCodeValue).then(()=> alert('Code copied')).catch(()=> alert('Copy failed'));
  } else alert('No code generated yet');
});

/* teacher set params and broadcast */
setTeacherWave.addEventListener('click', ()=> {
  const w = parseFloat(teacherWavelength.value) || 0;
  const f = parseFloat(teacherFrequency.value) || 0;
  const v = parseFloat((w * f).toFixed(4));
  teacherParams = { wavelength: w, frequency: f, velocity: v };
  updateTeacherUI();
  setStatus(teacherStatus, 'Parameters set & broadcast', true);
  // broadcast to all connections
  connections.forEach(c => {
    try{ c.send({ type:'params', params: teacherParams }); }catch(e){}
  });
});

/* Student connect */
connectBtn.addEventListener('click', ()=> {
  const code = (connectionCode.value || '').trim();
  const name = (studentName.value || '').trim();
  if(!code){ alert('Enter code'); return; }
  if(!name){ alert('Enter your name'); return; }
  studentStartSession(code, name);
});

/* compute velocities live for teacher & student */
teacherWavelength.addEventListener('input', ()=> {
  const w = parseFloat(teacherWavelength.value) || 0;
  const f = parseFloat(teacherFrequency.value) || 0;
  teacherVelocity.value = (f * w).toFixed(4);
});
teacherFrequency.addEventListener('input', ()=> { const w = parseFloat(teacherWavelength.value)||0; const f = parseFloat(teacherFrequency.value)||0; teacherVelocity.value = (f*w).toFixed(4); });

studentWavelength.addEventListener('input', ()=> {
  const w = parseFloat(studentWavelength.value) || 0;
  const f = parseFloat(studentFrequency.value) || 0;
  studentVelocity.value = (f * w).toFixed(4);
});
studentFrequency.addEventListener('input', ()=> { const w = parseFloat(studentWavelength.value)||0; const f = parseFloat(studentFrequency.value)||0; studentVelocity.value=(f*w).toFixed(4); });

/* Student check match: compare to last-known teacherParams (if received) or local teacher (if hosting) */
checkMatchBtn.addEventListener('click', ()=> {
  const sw = parseFloat(studentWavelength.value) || 0;
  const sf = parseFloat(studentFrequency.value) || 0;
  const sv = parseFloat((sw*sf).toFixed(4));
  studentParams = { wavelength: sw, frequency: sf, velocity: sv };
  updateStudentUI();

  // choose comparison target
  const target = teacherParams; // best available
  if(!target){ matchStatus.textContent = 'No teacher parameters available'; matchStatus.className='status disconnected'; return; }

  function approx(a,b){ const absTol=0.01; const relTol=0.005; return Math.abs(a-b) <= Math.max(absTol, Math.abs(b)*relTol); }
  const ok = approx(sw, target.wavelength) && approx(sf, target.frequency) && approx(sv, target.velocity);
  if(ok){
    matchStatus.textContent = 'Match Status: Connected! Values match'; matchStatus.className='status connected';
  } else {
    matchStatus.innerHTML = `Match Status: Not matched. Required λ=${target.wavelength}, f=${target.frequency}, v=${target.velocity}`;
    matchStatus.className='status disconnected';
  }

  // notify teacher of attempt if connected
  connections.forEach(c => {
    try{ c.send({ type:'matchAttempt', name: studentName.value || 'Student', params: studentParams }); }catch(e){}
  });
});

/* Stop controls */
stopTeacher.addEventListener('click', ()=> {
  if(peer) try{ peer.destroy(); }catch(e){}
  connections = [];
  teacherCodeValue = null;
  teacherCodeEl.textContent = 'Not generated';
  teacherScreen.style.display='none';
  cancelAnimationFrame(raf);
  setStatus(teacherStatus,'Locked / Not broadcasting', false);
  teacherStudentList.innerHTML = '<div class="student-item">No students connected yet</div>';
});
stopStudent.addEventListener('click', ()=> {
  if(peer) try{ peer.destroy(); }catch(e){}
  connections = [];
  studentScreen.style.display='none';
  cancelAnimationFrame(raf);
  setStatus(studentStatus,'Not connected', false);
});

/* Populate initial UI and start idle canvas */
updateTeacherUI(); updateStudentUI();
makeHiDPICanvas(canvas);
raf = requestAnimationFrame(animate);

/* Warn user about beforeunload if sessions active */
window.addEventListener('beforeunload', (e) => {
  if(peer){
    e.preventDefault();
    e.returnValue='';
  }
});
</script>
</body>
</html>
