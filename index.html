<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wave Matching Simulation — Debug Version</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
  body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;
    background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d)}
  .container{width:100%;max-width:1000px;background:rgba(255,255,255,.95);border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  h1{font-size:1.6rem;color:#2c3e50;text-align:center;margin-bottom:8px}
  .screens{min-height:64px}
  .screen{display:none}
  .screen.active{display:block}
  .center{display:flex;gap:14px;align-items:center;justify-content:center;margin:12px 0}
  .btn{padding:10px 18px;border-radius:40px;border:none;cursor:pointer;font-weight:700}
  .teacher-btn{background:linear-gradient(90deg,#3498db,#2980b9);color:white}
  .student-btn{background:linear-gradient(90deg,#2ecc71,#27ae60);color:white}
  .back-btn{background:#95a5a6;color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .two-col{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px}
  .panel{background:#f8f9fa;padding:12px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
  .control{margin-bottom:10px}
  label{font-weight:700;color:#2c3e50;margin-bottom:6px;display:block}
  input[type=range]{width:100%}
  input[type=number],input[type=text]{width:100%;padding:8px;border-radius:6px;border:2px solid #ddd}
  .canvas-wrap{background:#2c3e50;border-radius:8px;padding:6px}
  canvas{display:block;width:100%;height:200px}
  .match-indicator{height:10px;background:#e6e6e6;border-radius:6px;overflow:hidden;margin:8px 0}
  .match-progress{height:100%;width:0%;background:#2ecc71;transition:width .12s linear,background .12s linear}
  .connected-students{max-height:150px;overflow:auto;margin-top:10px}
  .student-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:#fff;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .debug{font-family:monospace;background:#fff;padding:8px;border-radius:6px;margin-top:8px;font-size:13px}
  .small{font-size:13px;color:#444}
  .controls-row{display:flex;gap:8px;align-items:center}
  .action-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .fill-btn{background:#3498db;color:white}
  .redraw-btn{background:#f39c12;color:white}
  .reset-btn{background:#e74c3c;color:white}
  @media (max-width:880px){ .two-col{grid-template-columns:1fr} canvas{height:160px} }
</style>
</head>
<body>
  <div class="container">
    <h1>Wave Matching Simulation — Debug mode</h1>

    <div class="center">
      <button class="btn teacher-btn" id="teacher-btn">I'm a Teacher</button>
      <button class="btn student-btn" id="student-btn">I'm a Student</button>
    </div>

    <div class="screens">
      <!-- Role selection (initial) -->
      <div id="role-selection" class="screen active panel">
        <p class="small">Choose role to start. Use the teacher controls to set the wave, then switch to Student to try to match it.</p>
      </div>

      <!-- Teacher screen -->
      <div id="teacher-screen" class="screen">
        <div class="two-col">
          <div class="panel">
            <h2 class="small">Teacher Controls</h2>

            <div class="control">
              <label>Frequency: <span id="freq-value" class="small">1.0 Hz</span></label>
              <input id="freq-slider" type="range" min="0.2" max="5.0" step="0.05" value="1.0">
            </div>

            <div class="control">
              <label>Amplitude: <span id="amp-value" class="small">1.0</span></label>
              <input id="amp-slider" type="range" min="0.1" max="3.0" step="0.05" value="1.0">
            </div>

            <div class="control">
              <label>Wavelength: <span id="wavelength-value" class="small">1.0</span></label>
              <input id="wavelength-slider" type="range" min="0.2" max="3.0" step="0.05" value="1.0">
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="action-btn redraw-btn" id="redraw-teacher">Redraw now</button>
              <button class="action-btn reset-btn" id="reset-connections">Reset connections</button>
              <button class="action-btn back-btn" id="teacher-back">Back</button>
            </div>

            <h3 class="small" style="margin-top:12px">Connected students (local demo)</h3>
            <div id="connected-list" class="connected-students"></div>
          </div>

          <div class="panel">
            <h3 class="small">Teacher Canvas</h3>
            <div class="canvas-wrap"><canvas id="teacher-canvas"></canvas></div>
            <div id="teacher-debug" class="debug"></div>
          </div>
        </div>
      </div>

      <!-- Student screen -->
      <div id="student-screen" class="screen">
        <div class="two-col">
          <div class="panel">
            <h2 class="small">Student Inputs</h2>

            <div class="control">
              <label>Your name</label>
              <input id="student-name" type="text" placeholder="Type your name">
            </div>

            <div class="control">
              <label>Frequency (Hz)</label>
              <input id="student-freq" type="number" step="0.05" min="0.2" max="5.0" placeholder="Leave empty to preview teacher value">
            </div>

            <div class="control">
              <label>Amplitude</label>
              <input id="student-amp" type="number" step="0.05" min="0.1" max="3.0" placeholder="Leave empty to preview teacher value">
            </div>

            <div class="control">
              <label>Wavelength</label>
              <input id="student-wavelength" type="number" step="0.05" min="0.2" max="3.0" placeholder="Leave empty to preview teacher value">
            </div>

            <div class="match-indicator">
              <div id="match-progress" class="match-progress" style="width:0%"></div>
            </div>
            <div id="match-text" class="small" style="margin-bottom:8px">Match: 0%</div>

            <div style="display:flex;gap:8px">
              <button class="action-btn fill-btn" id="fill-student">Fill student with teacher values</button>
              <button class="action-btn redraw-btn" id="redraw-student">Redraw now</button>
              <button class="action-btn back-btn" id="student-back">Back</button>
            </div>

            <div style="margin-top:8px">
              <button class="btn student-btn" id="submit-values" style="width:100%;margin-top:10px">Check & Connect</button>
            </div>

            <div id="connection-status" class="small" style="margin-top:8px;color:#111"></div>
          </div>

          <div class="panel">
            <h3 class="small">Student Canvas & Debug</h3>
            <div class="canvas-wrap"><canvas id="student-canvas"></canvas></div>
            <div id="student-debug" class="debug"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== Elements ====== */
const teacherBtn = document.getElementById('teacher-btn');
const studentBtn = document.getElementById('student-btn');
const roleSelection = document.getElementById('role-selection');
const teacherScreen = document.getElementById('teacher-screen');
const studentScreen = document.getElementById('student-screen');
const teacherBack = document.getElementById('teacher-back');
const studentBack = document.getElementById('student-back');

const freqSlider = document.getElementById('freq-slider');
const ampSlider = document.getElementById('amp-slider');
const wavelengthSlider = document.getElementById('wavelength-slider');
const freqValue = document.getElementById('freq-value');
const ampValue = document.getElementById('amp-value');
const wavelengthValue = document.getElementById('wavelength-value');

const teacherCanvas = document.getElementById('teacher-canvas');
const studentCanvas = document.getElementById('student-canvas');
const teacherCtx = teacherCanvas.getContext('2d');
const studentCtx = studentCanvas.getContext('2d');
const teacherDebug = document.getElementById('teacher-debug');
const studentDebug = document.getElementById('student-debug');

const studentName = document.getElementById('student-name');
const studentFreq = document.getElementById('student-freq');
const studentAmp = document.getElementById('student-amp');
const studentWavelength = document.getElementById('student-wavelength');
const matchProgress = document.getElementById('match-progress');
const matchText = document.getElementById('match-text');
const fillStudentBtn = document.getElementById('fill-student');
const submitBtn = document.getElementById('submit-values');
const connectionStatus = document.getElementById('connection-status');
const connectedList = document.getElementById('connected-list');
const resetConnections = document.getElementById('reset-connections');

const redrawTeacherBtn = document.getElementById('redraw-teacher');
const redrawStudentBtn = document.getElementById('redraw-student');

/* ====== State ====== */
let waveParams = { frequency: 1.0, amplitude: 1.0, wavelength: 1.0 };
let connectedStudents = [];

let teacherAnimation = null;
let studentAnimation = null;
let animTime = 0;

/* ====== Helpers ====== */
function showScreen(screenEl){
  roleSelection.classList.remove('active');
  teacherScreen.classList.remove('active');
  studentScreen.classList.remove('active');
  screenEl.classList.add('active');
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function toNum(v, fallback=NaN){
  if (v === '' || v === null || v === undefined) return fallback;
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}
function safeString(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ====== Canvas sizing & drawing ====== */
function initCanvases(){
  // ensure canvases sized to displayed width
  teacherCanvas.width = Math.max(300, Math.floor(teacherCanvas.clientWidth));
  teacherCanvas.height = 200;
  studentCanvas.width = Math.max(300, Math.floor(studentCanvas.clientWidth));
  studentCanvas.height = 200;
}
window.addEventListener('resize', ()=>{ initCanvases(); drawTeacherOnce(); drawStudentOnce(); });

function drawWave(ctx, canvas, params, t){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const centerY = h/2;
  ctx.beginPath();
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#3498db';
  for (let x=0;x<w;x++){
    // horizontal stretching uses wavelength: larger wavelength -> longer horizontal period
    const xFactor = (x / w) * Math.PI * 4;
    // prevent division by 0
    const wl = Math.max(0.01, params.wavelength);
    const y = centerY + Math.sin(xFactor / wl + t * params.frequency) * (centerY * 0.8 * params.amplitude);
    if (x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // baseline
  ctx.beginPath();
  ctx.strokeStyle = '#95a5a6';
  ctx.setLineDash([5,5]);
  ctx.lineWidth = 1;
  ctx.moveTo(0, centerY);
  ctx.lineTo(w, centerY);
  ctx.stroke();
  ctx.setLineDash([]);
}

/* single-frame draws for debug */
function drawTeacherOnce(){ drawWave(teacherCtx, teacherCanvas, waveParams, animTime); updateTeacherDebug(); }
function drawStudentOnce(){
  const s = getStudentPreviewParams();
  drawWave(studentCtx, studentCanvas, s, animTime);
  updateStudentDebug();
}

/* animation loops */
function animateTeacher(){
  drawWave(teacherCtx, teacherCanvas, waveParams, animTime);
  animTime += 0.04;
  teacherAnimation = requestAnimationFrame(animateTeacher);
}
function animateStudent(){
  const s = getStudentPreviewParams();
  drawWave(studentCtx, studentCanvas, s, animTime);
  // update progress and debug in animation for instant feedback
  updateMatchIndicator();
  animTime += 0.04;
  studentAnimation = requestAnimationFrame(animateStudent);
}

/* ====== UI updates & logic ====== */
function updateWaveParamsFromSliders(){
  waveParams.frequency = Number(freqSlider.value);
  waveParams.amplitude = Number(ampSlider.value);
  waveParams.wavelength = Number(wavelengthSlider.value);
  // reflect into UI
  freqValue.textContent = waveParams.frequency.toFixed(2) + ' Hz';
  ampValue.textContent = waveParams.amplitude.toFixed(2);
  wavelengthValue.textContent = waveParams.wavelength.toFixed(2);
  // redraw teacher canvas immediately
  drawTeacherOnce();
}

/* If a student field is empty we use teacher's value for preview only.
   For "Check & Connect" the student must enter numbers explicitly. */
function getStudentPreviewParams(){
  const sf = (studentFreq.value !== '') ? Number(studentFreq.value) : waveParams.frequency;
  const sa = (studentAmp.value !== '') ? Number(studentAmp.value) : waveParams.amplitude;
  const sw = (studentWavelength.value !== '') ? Number(studentWavelength.value) : waveParams.wavelength;
  return { frequency: clamp(sf, 0.01, 1000), amplitude: clamp(sa, 0.001, 1000), wavelength: clamp(sw, 0.001, 1000) };
}

function updateMatchIndicator(){
  const s = getStudentPreviewParams();
  const tol = 0.1;
  const freqMatch = Math.abs(s.frequency - waveParams.frequency) <= tol ? 1 : 0;
  const ampMatch = Math.abs(s.amplitude - waveParams.amplitude) <= tol ? 1 : 0;
  const wlMatch = Math.abs(s.wavelength - waveParams.wavelength) <= tol ? 1 : 0;
  const pct = Math.round((freqMatch + ampMatch + wlMatch) / 3 * 100);
  matchProgress.style.width = pct + '%';
  if (pct < 34) matchProgress.style.background = '#e74c3c';
  else if (pct < 100) matchProgress.style.background = '#f39c12';
  else matchProgress.style.background = '#2ecc71';
  matchText.textContent = `Match: ${pct}%`;
}

/* update small debug boxes */
function updateTeacherDebug(){
  teacherDebug.innerText = `teacher.waveParams = {\n  frequency: ${waveParams.frequency.toFixed(3)},\n  amplitude: ${waveParams.amplitude.toFixed(3)},\n  wavelength: ${waveParams.wavelength.toFixed(3)}\n}`;
}
function updateStudentDebug(){
  const sRaw = {
    studentFreq: studentFreq.value,
    studentAmp: studentAmp.value,
    studentWavelength: studentWavelength.value
  };
  const sPreview = getStudentPreviewParams();
  studentDebug.innerText = `student.raw = ${JSON.stringify(sRaw)}\nstudent.preview = ${JSON.stringify({
    frequency: Number(sPreview.frequency.toFixed(3)),
    amplitude: Number(sPreview.amplitude.toFixed(3)),
    wavelength: Number(sPreview.wavelength.toFixed(3))
  })}`;
}

/* ====== Connect / match logic ====== */
function checkAndConnect(){
  const name = (studentName.value || '').trim();
  const sFreq = toNum(studentFreq.value);
  const sAmp  = toNum(studentAmp.value);
  const sWl   = toNum(studentWavelength.value);

  if (!name){ connectionStatus.textContent = 'Please enter your name'; connectionStatus.style.color = '#b22222'; return; }
  if (Number.isNaN(sFreq) || Number.isNaN(sAmp) || Number.isNaN(sWl)){
    connectionStatus.textContent = 'Please fill the three numeric fields to Check & Connect (they may be prefilled by "Fill student" button)';
    connectionStatus.style.color = '#b22222';
    return;
  }

  const tol = 0.1;
  const freqMatch = Math.abs(sFreq - waveParams.frequency) <= tol;
  const ampMatch  = Math.abs(sAmp  - waveParams.amplitude) <= tol;
  const wlMatch   = Math.abs(sWl   - waveParams.wavelength) <= tol;

  if (freqMatch && ampMatch && wlMatch){
    connectionStatus.textContent = `Connected — Welcome, ${name}!`;
    connectionStatus.style.color = '#155724';
    // add or update local connected list
    const idx = connectedStudents.findIndex(s=>s.name===name);
    const entry = { name, frequency: sFreq, amplitude: sAmp, wavelength: sWl, time: new Date().toLocaleTimeString() };
    if (idx === -1) connectedStudents.push(entry); else connectedStudents[idx]=entry;
    renderConnectedList();
  } else {
    connectionStatus.textContent = `Parameters don't match. Try adjusting ${!freqMatch? 'frequency ':''}${!ampMatch? 'amplitude ':''}${!wlMatch? 'wavelength ':''}`;
    connectionStatus.style.color = '#b22222';
  }
  updateMatchIndicator();
}

function renderConnectedList(){
  if (connectedStudents.length === 0){ connectedList.innerHTML = '<div class="small">No connected students yet</div>'; return; }
  connectedList.innerHTML = connectedStudents.map(s=>`
    <div class="student-item">
      <div><strong>${safeString(s.name)}</strong><span style="margin-left:8px;color:#666">F:${Number(s.frequency).toFixed(2)} A:${Number(s.amplitude).toFixed(2)} W:${Number(s.wavelength).toFixed(2)}</span></div>
      <div style="color:#888;font-size:12px">${safeString(s.time)}</div>
    </div>`).join('');
}

/* ====== UI wiring ====== */
teacherBtn.addEventListener('click', ()=>{ showScreen(teacherScreen); initCanvases(); startTeacherAnimation(); updateMatchIndicator(); });
studentBtn.addEventListener('click', ()=>{ showScreen(studentScreen); initCanvases(); startStudentAnimation(); updateMatchIndicator(); connectionStatus.textContent=''; });

teacherBack.addEventListener('click', ()=>{ showScreen(roleSelection); stopAllAnimations(); });
studentBack.addEventListener('click', ()=>{ showScreen(roleSelection); stopAllAnimations(); });

freqSlider.addEventListener('input', ()=>{ updateWaveParamsFromSliders(); updateMatchIndicator(); });
ampSlider.addEventListener('input', ()=>{ updateWaveParamsFromSliders(); updateMatchIndicator(); });
wavelengthSlider.addEventListener('input', ()=>{ updateWaveParamsFromSliders(); updateMatchIndicator(); });

redrawTeacherBtn.addEventListener('click', ()=>{ drawTeacherOnce(); });
redrawStudentBtn.addEventListener('click', ()=>{ drawStudentOnce(); });

studentFreq.addEventListener('input', ()=>{ updateMatchIndicator(); });
studentAmp.addEventListener('input', ()=>{ updateMatchIndicator(); });
studentWavelength.addEventListener('input', ()=>{ updateMatchIndicator(); });

fillStudentBtn.addEventListener('click', ()=>{
  // fill numeric fields with teacher values for testing
  studentFreq.value = waveParams.frequency;
  studentAmp.value = waveParams.amplitude;
  studentWavelength.value = waveParams.wavelength;
  updateMatchIndicator(); drawStudentOnce();
});

submitBtn.addEventListener('click', ()=>{ checkAndConnect(); });

resetConnections.addEventListener('click', ()=>{
  connectedStudents = [];
  renderConnectedList();
});

/* ====== Animation control (safe start/stop) ====== */
function startTeacherAnimation(){
  cancelAnimationFrame(teacherAnimation);
  teacherAnimation = requestAnimationFrame(function loop(){
    drawWave(teacherCtx, teacherCanvas, waveParams, animTime);
    animTime += 0.04;
    updateTeacherDebug();
    teacherAnimation = requestAnimationFrame(loop);
  });
}
function startStudentAnimation(){
  cancelAnimationFrame(studentAnimation);
  studentAnimation = requestAnimationFrame(function loop(){
    const s = getStudentPreviewParams();
    drawWave(studentCtx, studentCanvas, s, animTime);
    animTime += 0.04;
    updateStudentDebug();
    updateMatchIndicator();
    studentAnimation = requestAnimationFrame(loop);
  });
}
function stopAllAnimations(){
  cancelAnimationFrame(teacherAnimation);
  cancelAnimationFrame(studentAnimation);
  teacherAnimation = null;
  studentAnimation = null;
}

/* ====== init ====== */
initCanvases();
updateWaveParamsFromSliders();
renderConnectedList();
updateTeacherDebug();
updateStudentDebug();

/* start teacher animation automatically so you can test right away if desired */
startTeacherAnimation();
</script>
</body>
</html>
