<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wave Simulator ‚Äî Teacher / Student Matching (Improved)</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        :root{
            --bg1:#081028; --bg2:#2b2e83; --accent:#ff7e00; --accent2:#00a2ff; --glass:rgba(255,255,255,0.06)
        }
        body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;padding:20px;display:flex;align-items:center;justify-content:center}
        .container{width:100%;max-width:1200px;display:flex;flex-direction:column;gap:18px}
        header{padding:18px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);text-align:center}
        h1{font-size:1.9rem;letter-spacing:0.5px}
        p.lead{opacity:0.9;margin-top:6px}

        .role-selection{display:flex;gap:20px;justify-content:center}
        .role-card{width:240px;padding:18px;border-radius:10px;background:var(--glass);text-align:center;cursor:pointer;transition:transform .22s, box-shadow .22s}
        .role-card:hover{transform:translateY(-8px);box-shadow:0 10px 30px rgba(0,0,0,0.35)}
        .role-card .icon{font-size:44px;margin-bottom:8px}
        .role-card h2{font-size:1.25rem}

        .simulator-container{display:none;gap:18px;align-items:flex-start}
        .panel{flex:1;min-width:320px;background:rgba(0,0,0,0.45);padding:18px;border-radius:10px}
        .canvas-container{flex:2;min-width:320px;background:rgba(0,0,0,0.45);padding:18px;border-radius:10px;display:flex;flex-direction:column}
        .waveCanvas{background:rgba(255,255,255,0.02);border-radius:6px;width:100%;height:320px}

        label{display:block;margin-bottom:6px;font-weight:600}
        input[type=number],input[type=text],input[type=password]{width:100%;padding:10px;border-radius:6px;border:none;background:#fff;color:#111;font-size:0.98rem}
        .row{display:flex;gap:10px}
        .small{flex:1}
        button{padding:10px 12px;border:none;border-radius:8px;background:linear-gradient(180deg,#4CAF50,#3e8e41);color:#fff;font-weight:700;cursor:pointer}
        .teacher-btn{background:linear-gradient(180deg,#ff8a2b,#e66d00)}
        .copy-btn{background:linear-gradient(180deg,#2196F3,#0b7dda)}
        .back-btn{background:linear-gradient(180deg,#6c757d,#5a6268)}
        .muted{opacity:0.85;font-size:0.95rem}

        .status{margin-top:12px;padding:12px;border-radius:8px;text-align:center;font-weight:700;background:rgba(255,255,255,0.04)}
        .connected{background:rgba(76,175,80,0.18);color:#bfffbf}
        .disconnected{background:rgba(175,76,76,0.12);color:#ffdede}

        .student-list{margin-top:12px;max-height:180px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px}
        .student-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between}

        .code-display{background:rgba(255,255,255,0.06);padding:10px;border-radius:6px;text-align:center;font-weight:800;letter-spacing:3px}
        .controls{display:flex;gap:10px;margin-top:10px}

        .password-prompt{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:999}
        .password-box{background:rgba(0,0,0,0.85);padding:22px;border-radius:10px;width:360px}

        .wave-info{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
        .info-item{background:rgba(255,255,255,0.03);padding:10px;border-radius:6px;min-width:110px;text-align:center}
        .info-item span{display:block;font-size:1.1rem;font-weight:800;color:#fff;margin-top:6px}

        footer{opacity:0.8;text-align:center;font-size:0.9rem;margin-top:6px}

        @media(max-width:900px){.simulator-container{flex-direction:column}.role-selection{flex-direction:column;align-items:center}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wave Simulator: Teacher ‚Üî Student Matching</h1>
            <p class="lead">Green-light received ‚úÖ ‚Äî I improved visuals, physics mapping, animation, matching logic and usability.</p>
        </header>

        <div class="role-selection">
            <div class="role-card teacher" id="teacherRole">
                <div class="icon">üë®‚Äçüè´</div>
                <h2>Teacher</h2>
                <p class="muted">Set wave parameters, generate a code, and share it with your students.</p>
            </div>

            <div class="role-card student" id="studentRole">
                <div class="icon">üë®‚Äçüéì</div>
                <h2>Student</h2>
                <p class="muted">Enter the code and try to match the teacher's wave.</p>
            </div>
        </div>

        <!-- Password prompt (simple) -->
        <div class="password-prompt" id="passwordPrompt">
            <div class="password-box">
                <h2>Teacher Password</h2>
                <p class="muted">Default password: <strong>DHH</strong> (you can change it inside the file)</p>
                <div style="margin-top:8px"><input type="password" id="passwordInput" placeholder="Enter password" /></div>
                <div style="display:flex;gap:8px;margin-top:10px">
                    <button id="submitPassword" class="teacher-btn">Unlock</button>
                    <button id="cancelPassword" class="back-btn">Cancel</button>
                </div>
                <div id="passwordError" style="color:#ff6b6b;margin-top:8px;display:none">Incorrect password</div>
            </div>
        </div>

        <!-- Teacher screen -->
        <div class="simulator-container" id="teacherScreen">
            <div class="panel">
                <h2>üë®‚Äçüè´ Teacher</h2>

                <div class="input-group">
                    <label for="teacherWavelength">Wavelength (m)</label>
                    <input type="number" id="teacherWavelength" min="0.1" max="500" step="0.1" value="40">
                </div>
                <div class="row" style="margin-top:8px">
                    <div class="small">
                        <label for="teacherFrequency">Frequency (Hz)</label>
                        <input type="number" id="teacherFrequency" min="0.01" max="100" step="0.01" value="1.5">
                    </div>
                    <div class="small">
                        <label for="teacherVelocity">Velocity (m/s) ‚Äî computed</label>
                        <input type="number" id="teacherVelocity" min="0.01" max="10000" step="0.1" value="60" readonly>
                    </div>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px">
                    <button id="setTeacherWave" class="teacher-btn">Set & Broadcast</button>
                    <button id="regenCode" class="copy-btn">Regenerate Code</button>
                </div>

                <div style="margin-top:10px">
                    <label>Connection Code (share this)</label>
                    <div class="code-display" id="teacherCode">Not generated</div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button id="copyCode" class="copy-btn">Copy Code</button>
                        <button id="clearTeacher" class="back-btn">Clear</button>
                    </div>
                </div>

                <div id="teacherStatus" class="status disconnected">Waiting for teacher to set parameters</div>

                <h3 style="margin-top:12px">Connected Students</h3>
                <div class="student-list" id="teacherStudentList"><div class="student-item">No students connected yet</div></div>

                <div style="margin-top:12px;display:flex;gap:8px">
                    <button id="backFromTeacher" class="back-btn">Back</button>
                </div>

            </div>

            <div class="canvas-container">
                <h2>Wave Simulation</h2>
                <canvas id="teacherWaveCanvas" class="waveCanvas"></canvas>

                <div class="wave-info">
                    <div class="info-item">Wavelength<span id="displayWavelength">40</span>m</div>
                    <div class="info-item">Frequency<span id="displayFrequency">1.5</span>Hz</div>
                    <div class="info-item">Velocity<span id="displayVelocity">60</span>m/s</div>
                </div>
            </div>
        </div>

        <!-- Student screen -->
        <div class="simulator-container" id="studentScreen">
            <div class="panel">
                <h2>üë®‚Äçüéì Student</h2>

                <div class="input-group">
                    <label for="connectionCode">Connection Code</label>
                    <input type="text" id="connectionCode" placeholder="Enter code from teacher">
                </div>
                <div class="input-group" style="margin-top:8px">
                    <label for="studentName">Your Name</label>
                    <input type="text" id="studentName" placeholder="Enter your name">
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                    <div class="small">
                        <label for="studentWavelength">Wavelength (m)</label>
                        <input type="number" id="studentWavelength" min="0.1" max="500" step="0.1" value="20">
                    </div>
                    <div class="small">
                        <label for="studentFrequency">Frequency (Hz)</label>
                        <input type="number" id="studentFrequency" min="0.01" max="100" step="0.01" value="2">
                    </div>
                </div>

                <div style="margin-top:8px">
                    <label for="studentVelocity">Velocity (m/s) ‚Äî computed</label>
                    <input type="number" id="studentVelocity" readonly>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px">
                    <button id="checkMatch">Check Match</button>
                    <button id="fillFromTeacher" class="copy-btn">Fill from Teacher (if available)</button>
                </div>

                <div id="studentStatus" class="status disconnected">Not connected</div>
                <div id="matchStatus" class="status disconnected">Match Status: Waiting</div>

                <div style="margin-top:12px"><button id="backFromStudent" class="back-btn">Back</button></div>
            </div>

            <div class="canvas-container">
                <h2>Wave Simulation</h2>
                <canvas id="studentWaveCanvas" class="waveCanvas"></canvas>

                <div class="wave-info">
                    <div class="info-item">Wavelength<span id="studentDisplayWavelength">20</span>m</div>
                    <div class="info-item">Frequency<span id="studentDisplayFrequency">2</span>Hz</div>
                    <div class="info-item">Velocity<span id="studentDisplayVelocity">40</span>m/s</div>
                </div>
            </div>
        </div>

        <footer>Tips: Velocity is computed automatically as v = f √ó Œª. Use the "Fill from Teacher" button on the student side if the teacher has broadcast parameters in the same browser.</footer>
    </div>

    <script>
    (function(){
        // Elements
        const roleSelection = document.querySelector('.role-selection');
        const teacherScreen = document.getElementById('teacherScreen');
        const studentScreen = document.getElementById('studentScreen');
        const teacherRole = document.getElementById('teacherRole');
        const studentRole = document.getElementById('studentRole');

        const passwordPrompt = document.getElementById('passwordPrompt');
        const passwordInput = document.getElementById('passwordInput');
        const submitPassword = document.getElementById('submitPassword');
        const cancelPassword = document.getElementById('cancelPassword');
        const passwordError = document.getElementById('passwordError');

        // Teacher elems
        const teacherWavelength = document.getElementById('teacherWavelength');
        const teacherFrequency = document.getElementById('teacherFrequency');
        const teacherVelocity = document.getElementById('teacherVelocity');
        const setTeacherWave = document.getElementById('setTeacherWave');
        const teacherStatus = document.getElementById('teacherStatus');
        const displayWavelength = document.getElementById('displayWavelength');
        const displayFrequency = document.getElementById('displayFrequency');
        const displayVelocity = document.getElementById('displayVelocity');
        const teacherCanvas = document.getElementById('teacherWaveCanvas');
        const teacherCtx = teacherCanvas.getContext('2d');
        const teacherStudentList = document.getElementById('teacherStudentList');
        const teacherCode = document.getElementById('teacherCode');
        const copyCode = document.getElementById('copyCode');
        const regenCode = document.getElementById('regenCode');
        const clearTeacher = document.getElementById('clearTeacher');
        const backFromTeacher = document.getElementById('backFromTeacher');

        // Student elems
        const connectionCode = document.getElementById('connectionCode');
        const studentName = document.getElementById('studentName');
        const studentWavelength = document.getElementById('studentWavelength');
        const studentFrequency = document.getElementById('studentFrequency');
        const studentVelocity = document.getElementById('studentVelocity');
        const checkMatch = document.getElementById('checkMatch');
        const studentStatus = document.getElementById('studentStatus');
        const matchStatus = document.getElementById('matchStatus');
        const studentDisplayWavelength = document.getElementById('studentDisplayWavelength');
        const studentDisplayFrequency = document.getElementById('studentDisplayFrequency');
        const studentDisplayVelocity = document.getElementById('studentDisplayVelocity');
        const studentCanvas = document.getElementById('studentWaveCanvas');
        const studentCtx = studentCanvas.getContext('2d');
        const fillFromTeacher = document.getElementById('fillFromTeacher');
        const backFromStudent = document.getElementById('backFromStudent');

        // State
        let teacherWaveParams = {wavelength:40, frequency:1.5, velocity:60};
        let studentWaveParams = {wavelength:20, frequency:2, velocity:40};
        let connectedStudents = [];
        let teacherCodeValue = null;
        const PASSWORD = 'DHH'; // small convenience ‚Äî change if you want

        // Animation variables (time-based)
        let teacherAnim = {last:0, t:0};
        let studentAnim = {last:0, t:0};
        let teacherRAF = null, studentRAF = null;

        // High-DPI canvas helper
        function makeHiDPICanvas(canvas){
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = Math.max(1, Math.floor(rect.width * dpr));
            canvas.height = Math.max(1, Math.floor(rect.height * dpr));
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr,0,0,dpr,0,0);
            return ctx;
        }

        // Map physical wavelength (m) to pixels ‚Äî a simple adaptive scale so small & large values remain visible
        function lambdaToPixels(lambda, canvasWidth){
            // We'll try to map so that 1/4..1/2 of the canvas width corresponds to typical wavelengths
            // Use a multiplier that keeps visualization sensible across ranges
            const base = Math.max(20, lambda * 6); // at least 20 px per wavelength
            // clamp so it doesn't explode for huge lambda
            return Math.min(base, canvasWidth * 0.6);
        }

        // draw helpers
        function drawGrid(ctx, canvas){
            const w = canvas.width / (window.devicePixelRatio||1);
            const h = canvas.height / (window.devicePixelRatio||1);
            ctx.clearRect(0,0,w,h);
            ctx.save();
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for(let y=0;y<=h;y+=24){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke()}
            for(let x=0;x<=w;x+=24){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke()}
            // axis
            ctx.strokeStyle = 'rgba(255,255,255,0.18)';
            ctx.lineWidth = 2;
            ctx.beginPath();ctx.moveTo(0,h/2);ctx.lineTo(w,h/2);ctx.stroke();
            ctx.restore();
        }

        function drawWave(ctx, canvas, params, time, opts={color:'#4CAF50'}){
            const w = canvas.width/(window.devicePixelRatio||1);
            const h = canvas.height/(window.devicePixelRatio||1);
            const amp = h*0.18; // amplitude in pixels

            const lambda_px = lambdaToPixels(params.wavelength, w);
            const k = 2*Math.PI / lambda_px; // spatial frequency (rad / px)
            const omega = 2*Math.PI * params.frequency; // rad / s

            ctx.save();
            ctx.lineWidth = 3;
            ctx.strokeStyle = opts.color;
            ctx.beginPath();
            for(let x=0;x<=w;x++){
                const y = h/2 + amp * Math.sin(k*x - omega*time);
                if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();

            // particles
            ctx.fillStyle = '#FF9800';
            for(let x=0;x<=w;x+=Math.max(16, Math.floor(lambda_px/8))){
                const y = h/2 + amp * Math.sin(k*x - omega*time);
                ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();
            }

            // wavelength indicator
            const centerX = w/2;
            const wx1 = centerX - lambda_px/2;
            const wx2 = centerX + lambda_px/2;
            ctx.strokeStyle = '#FF4081';
            ctx.lineWidth = 2;
            ctx.beginPath();ctx.moveTo(wx1,h*0.12);ctx.lineTo(wx2,h*0.12);ctx.stroke();
            ctx.beginPath();ctx.moveTo(wx1,h*0.12-8);ctx.lineTo(wx1,h*0.12+8);ctx.stroke();
            ctx.beginPath();ctx.moveTo(wx2,h*0.12-8);ctx.lineTo(wx2,h*0.12+8);ctx.stroke();
            ctx.font = '14px Arial';ctx.fillStyle='white';ctx.textAlign='center';
            ctx.fillText(`Œª ‚âà ${params.wavelength} m (${Math.round(lambda_px)} px)`, centerX, h*0.12-12);

            // amplitude label
            ctx.beginPath();ctx.moveTo(centerX+lambda_px*0.75,h/2);ctx.lineTo(centerX+lambda_px*0.75,h/2-amp);ctx.stroke();
            ctx.fillText('Amplitude', centerX+lambda_px*0.75+36, h/2-amp/2);

            // direction arrow
            ctx.beginPath();ctx.moveTo(w-26,h/2-20);ctx.lineTo(w-14,h/2);ctx.lineTo(w-26,h/2+20);ctx.strokeStyle='#FF4081';ctx.lineWidth=3;ctx.stroke();
            ctx.restore();
        }

        // Animation loops (time-based)
        function animateTeacher(timestamp){
            if(!teacherAnim.last) teacherAnim.last = timestamp;
            const dt = (timestamp - teacherAnim.last)/1000; // seconds
            teacherAnim.last = timestamp;
            teacherAnim.t += dt;

            // draw
            const ctx = makeHiDPICanvas(teacherCanvas);
            drawGrid(ctx, teacherCanvas);
            drawWave(ctx, teacherCanvas, teacherWaveParams, teacherAnim.t, {color:'#ffb86b'});

            teacherRAF = requestAnimationFrame(animateTeacher);
        }

        function animateStudent(timestamp){
            if(!studentAnim.last) studentAnim.last = timestamp;
            const dt = (timestamp - studentAnim.last)/1000;
            studentAnim.last = timestamp;
            studentAnim.t += dt;

            const ctx = makeHiDPICanvas(studentCanvas);
            drawGrid(ctx, studentCanvas);
            drawWave(ctx, studentCanvas, studentWaveParams, studentAnim.t, {color:'#64b5ff'});

            studentRAF = requestAnimationFrame(animateStudent);
        }

        // Utilities
        function generateCode(){
            return Math.random().toString(36).substring(2,8).toUpperCase();
        }

        function updateTeacherUI(){
            displayWavelength.textContent = teacherWaveParams.wavelength;
            displayFrequency.textContent = teacherWaveParams.frequency;
            displayVelocity.textContent = teacherWaveParams.velocity;

            teacherWavelength.value = teacherWaveParams.wavelength;
            teacherFrequency.value = teacherWaveParams.frequency;
            teacherVelocity.value = teacherWaveParams.velocity;
        }

        function updateStudentUI(){
            studentDisplayWavelength.textContent = studentWaveParams.wavelength;
            studentDisplayFrequency.textContent = studentWaveParams.frequency;
            studentDisplayVelocity.textContent = studentWaveParams.velocity;

            studentWavelength.value = studentWaveParams.wavelength;
            studentFrequency.value = studentWaveParams.frequency;
            studentVelocity.value = studentWaveParams.velocity;
        }

        // compute velocity v = f * lambda
        function computeVelocityFrom(f, lambda){
            return parseFloat((f * lambda).toFixed(4));
        }

        // Set teacher parameters and broadcast to localStorage
        function setTeacherWaveParams(){
            const w = parseFloat(teacherWavelength.value) || 0;
            const f = parseFloat(teacherFrequency.value) || 0;
            const v = computeVelocityFrom(f,w);
            teacherWaveParams = {wavelength:w, frequency:f, velocity:v};
            teacherCodeValue = teacherCodeValue || generateCode();

            updateTeacherUI();
            teacherStatus.textContent = 'Parameters set and broadcasted';
            teacherStatus.className = 'status connected';

            // store
            localStorage.setItem('waveTeacherCode', teacherCodeValue);
            localStorage.setItem('waveTeacherParams', JSON.stringify(teacherWaveParams));

            // reset connected students list in this tab
            connectedStudents = [];
            refreshStudentListUI();
        }

        function refreshStudentListUI(){
            teacherStudentList.innerHTML = '';
            if(connectedStudents.length===0){
                teacherStudentList.innerHTML = '<div class="student-item">No students connected yet</div>';
                return;
            }
            connectedStudents.forEach(s=>{
                const el = document.createElement('div');el.className='student-item';
                el.innerHTML = `<div>${s}</div><div style="color:#bfffbf">‚óè</div>`;
                teacherStudentList.appendChild(el);
            });
        }

        // Student attempts to match
        function checkMatchParams(){
            const name = (studentName.value||'').trim();
            if(!name){ matchStatus.textContent='Please enter your name first'; matchStatus.className='status disconnected'; return; }
            const code = (connectionCode.value||'').trim();
            if(!code){ matchStatus.textContent='Please enter connection code'; matchStatus.className='status disconnected'; return; }
            const storedCode = localStorage.getItem('waveTeacherCode');
            const storedParams = localStorage.getItem('waveTeacherParams');
            if(!storedCode || !storedParams){ matchStatus.textContent='No teacher is broadcasting right now'; matchStatus.className='status disconnected'; return; }
            if(code !== storedCode){ matchStatus.textContent='Invalid connection code'; matchStatus.className='status disconnected'; return; }

            // update student computed velocity
            const sw = parseFloat(studentWavelength.value)||0;
            const sf = parseFloat(studentFrequency.value)||0;
            const sv = computeVelocityFrom(sf,sw);
            studentWaveParams = {wavelength:sw, frequency:sf, velocity:sv};
            updateStudentUI();

            const teacherParams = JSON.parse(storedParams);

            // Compare with a tolerance: use relative tolerance of 0.5% or absolute 0.01
            function approx(a,b){
                const absTol = 0.01;
                const relTol = Math.max(0.005, 0.0001);
                return Math.abs(a-b) <= Math.max(absTol, Math.abs(b)*relTol);
            }

            const match = approx(studentWaveParams.wavelength, teacherParams.wavelength) && approx(studentWaveParams.frequency, teacherParams.frequency) && approx(studentWaveParams.velocity, teacherParams.velocity);

            if(match){
                matchStatus.textContent='Match Status: Connected!'; matchStatus.className='status connected';
                studentStatus.textContent='Match Connected!'; studentStatus.className='status connected';
                // add to teacher list in this tab if code matches and teacher present
                if(!connectedStudents.includes(name)){
                    connectedStudents.push(name); refreshStudentListUI();
                }
            } else {
                matchStatus.innerHTML = `Match Status: Values do not match.<br>Required: Œª=${teacherParams.wavelength}, f=${teacherParams.frequency}, v=${teacherParams.velocity}`;
                matchStatus.className='status disconnected';
                studentStatus.textContent='No connection'; studentStatus.className='status disconnected';
            }
        }

        // Fill student fields from stored teacher params (if available)
        function fillStudentFromTeacher(){
            const stored = localStorage.getItem('waveTeacherParams');
            if(!stored){ matchStatus.textContent='No teacher parameters available in this browser'; matchStatus.className='status disconnected'; return; }
            const t = JSON.parse(stored);
            studentWavelength.value = t.wavelength; studentFrequency.value = t.frequency; studentVelocity.value = t.velocity;
            studentWaveParams = {...t}; updateStudentUI();
            matchStatus.textContent='Fields filled from teacher (local)'; matchStatus.className='status connected';
        }

        // copy helpers
        function copyToClipboard(text, btn){
            navigator.clipboard.writeText(text).then(()=>{
                const old = btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,1500);
            }).catch(()=>{ alert('Copy failed ‚Äî please copy manually: ' + text); });
        }

        // Events
        teacherRole.addEventListener('click', ()=>{ passwordPrompt.style.display='flex'; });
        cancelPassword.addEventListener('click', ()=>{ passwordPrompt.style.display='none'; passwordInput.value=''; passwordError.style.display='none'; });

        submitPassword.addEventListener('click', ()=>{
            if(passwordInput.value === PASSWORD){
                passwordPrompt.style.display='none'; passwordInput.value=''; passwordError.style.display='none';
                roleSelection.style.display='none'; teacherScreen.style.display='flex';
                // generate code if none
                teacherCodeValue = localStorage.getItem('waveTeacherCode') || generateCode();
                teacherCode.textContent = teacherCodeValue;
                // load params if present
                const stored = localStorage.getItem('waveTeacherParams');
                if(stored){ teacherWaveParams = JSON.parse(stored); }
                updateTeacherUI();
                // start animation
                cancelAnimationFrame(teacherRAF); teacherAnim = {last:0,t:0}; teacherRAF = requestAnimationFrame(animateTeacher);
                refreshStudentListUI();
            } else {
                passwordError.style.display='block';
            }
        });

        studentRole.addEventListener('click', ()=>{
            roleSelection.style.display='none'; studentScreen.style.display='flex';
            cancelAnimationFrame(studentRAF); studentAnim = {last:0,t:0}; studentRAF = requestAnimationFrame(animateStudent);
        });

        // when teacher sets params
        setTeacherWave.addEventListener('click', ()=>{
            // if no code yet, generate one
            if(!teacherCodeValue) teacherCodeValue = generateCode();
            teacherCode.textContent = teacherCodeValue;
            setTeacherWaveParams();
        });

        regenCode.addEventListener('click', ()=>{
            teacherCodeValue = generateCode(); teacherCode.textContent = teacherCodeValue; localStorage.setItem('waveTeacherCode', teacherCodeValue);
        });

        copyCode.addEventListener('click', ()=>{ if(teacherCode.textContent && teacherCode.textContent !== 'Not generated'){ copyToClipboard(teacherCode.textContent, copyCode); } });
        clearTeacher.addEventListener('click', ()=>{
            teacherCodeValue = null; teacherCode.textContent = 'Not generated'; teacherStatus.textContent='Teacher cleared'; teacherStatus.className='status disconnected';
            localStorage.removeItem('waveTeacherCode'); localStorage.removeItem('waveTeacherParams'); connectedStudents = []; refreshStudentListUI();
        });

        backFromTeacher.addEventListener('click', ()=>{
            teacherScreen.style.display='none'; roleSelection.style.display='flex'; cancelAnimationFrame(teacherRAF); teacherAnim={last:0,t:0};
        });

        backFromStudent.addEventListener('click', ()=>{
            studentScreen.style.display='none'; roleSelection.style.display='flex'; cancelAnimationFrame(studentRAF); studentAnim={last:0,t:0};
        });

        // student interactions
        checkMatch.addEventListener('click', checkMatchParams);
        fillFromTeacher.addEventListener('click', fillStudentFromTeacher);

        // live updates for velocity
        teacherWavelength.addEventListener('input', ()=>{
            const w = parseFloat(teacherWavelength.value)||0; const f = parseFloat(teacherFrequency.value)||0; teacherVelocity.value = computeVelocityFrom(f,w);
        });
        teacherFrequency.addEventListener('input', ()=>{ const w = parseFloat(teacherWavelength.value)||0; const f = parseFloat(teacherFrequency.value)||0; teacherVelocity.value = computeVelocityFrom(f,w); });
        studentWavelength.addEventListener('input', ()=>{ const w = parseFloat(studentWavelength.value)||0; const f = parseFloat(studentFrequency.value)||0; studentVelocity.value = computeVelocityFrom(f,w); studentWaveParams.wavelength=w; updateStudentUI(); });
        studentFrequency.addEventListener('input', ()=>{ const w = parseFloat(studentWavelength.value)||0; const f = parseFloat(studentFrequency.value)||0; studentVelocity.value = computeVelocityFrom(f,w); studentWaveParams.frequency=f; updateStudentUI(); });

        // regen / load teacher code on open
        window.addEventListener('load', ()=>{
            // set initial UI values
            teacherWaveParams = {wavelength:parseFloat(teacherWavelength.value), frequency:parseFloat(teacherFrequency.value), velocity:computeVelocityFrom(parseFloat(teacherFrequency.value),parseFloat(teacherWavelength.value))};
            studentWaveParams = {wavelength:parseFloat(studentWavelength.value), frequency:parseFloat(studentFrequency.value), velocity:computeVelocityFrom(parseFloat(studentFrequency.value),parseFloat(studentWavelength.value))};
            updateTeacherUI(); updateStudentUI();
            // ensure canvases sized properly
            makeHiDPICanvas(teacherCanvas); makeHiDPICanvas(studentCanvas);
        });

        // responsive resize
        window.addEventListener('resize', ()=>{ makeHiDPICanvas(teacherCanvas); makeHiDPICanvas(studentCanvas); });

    })();
    </script>
</body>
</html>
